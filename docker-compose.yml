name: euprava25

services:
  # ─── Databases ───────────────────────────────────────────────────────────────
  postgres-sso:
    image: postgres:16-alpine
    container_name: euprava25-postgres-sso
    environment:
      POSTGRES_USER: ${SSO_DB_USER}
      POSTGRES_PASSWORD: ${SSO_DB_PASSWORD}
      POSTGRES_DB: ${SSO_DB_NAME}
    ports:
      - "5433:5432"
    volumes:
      - sso_pgdata:/var/lib/postgresql/data
      - ./db/sso:/docker-entrypoint-initdb.d
    networks:
      - euprava-network
    restart: unless-stopped

  postgres-school:
    image: postgres:16-alpine
    container_name: euprava25-postgres-school
    environment:
      POSTGRES_USER: ${SCHOOL_DB_USER}
      POSTGRES_PASSWORD: ${SCHOOL_DB_PASSWORD}
      POSTGRES_DB: ${SCHOOL_DB_NAME}
    ports:
      - "5434:5432"
    volumes:
      - school_pgdata:/var/lib/postgresql/data
    networks:
      - euprava-network
    restart: unless-stopped

  postgres-health:
    image: postgres:16-alpine
    container_name: euprava25-postgres-health
    environment:
      POSTGRES_USER: ${HEALTH_DB_USER}
      POSTGRES_PASSWORD: ${HEALTH_DB_PASSWORD}
      POSTGRES_DB: ${HEALTH_DB_NAME}
    ports:
      - "5435:5432"
    volumes:
      - health_pgdata:/var/lib/postgresql/data
    networks:
      - euprava-network
    restart: unless-stopped

  # ─── Backend Services ─────────────────────────────────────────────────────────
  sso-service:
    build:
      context: ./sso-service
      dockerfile: Dockerfile
    container_name: euprava25-sso
    ports:
      - "8081:8080"
    environment:
      - DATABASE_URL=postgres://${SSO_DB_USER}:${SSO_DB_PASSWORD}@postgres-sso:5432/${SSO_DB_NAME}?sslmode=disable
      - DB_HOST=postgres-sso
      - DB_USER=${SSO_DB_USER}
      - DB_PASSWORD=${SSO_DB_PASSWORD}
      - DB_NAME=${SSO_DB_NAME}
      - DB_PORT=5432
      - JWT_SECRET=${JWT_SECRET}
      - JWT_TTL_MINUTES=${JWT_TTL_MINUTES}
    depends_on:
      - postgres-sso
    networks:
      - euprava-network
    restart: unless-stopped

  school-service:
    build:
      context: ./school-service
      dockerfile: Dockerfile
    container_name: euprava25-school
    ports:
      - "8082:8080"
    environment:
      - DB_HOST=postgres-school
      - DB_USER=${SCHOOL_DB_USER}
      - DB_PASSWORD=${SCHOOL_DB_PASSWORD}
      - DB_NAME=${SCHOOL_DB_NAME}
      - DB_PORT=5432
      - JWT_SECRET=${JWT_SECRET}
    volumes:
      - uploads_data:/uploads
    depends_on:
      - postgres-school
    networks:
      - euprava-network
    restart: unless-stopped

  health-service:
    build:
      context: ./health-service
      dockerfile: Dockerfile
    container_name: euprava25-health
    ports:
      - "8083:8080"
    environment:
      - DB_HOST=postgres-health
      - DB_USER=${HEALTH_DB_USER}
      - DB_PASSWORD=${HEALTH_DB_PASSWORD}
      - DB_NAME=${HEALTH_DB_NAME}
      - DB_PORT=5432
      - JWT_SECRET=${JWT_SECRET}
    depends_on:
      - postgres-health
    networks:
      - euprava-network
    restart: unless-stopped

  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    container_name: euprava25-gateway
    ports:
      - "8080:8080"
    environment:
      - SSO_SERVICE_URL=http://sso-service:8080
      - SCHOOL_SERVICE_URL=http://school-service:8080
      - HEALTH_SERVICE_URL=http://health-service:8080
    depends_on:
      - sso-service
      - school-service
      - health-service
    networks:
      - euprava-network
    restart: unless-stopped

  # ─── Frontend ─────────────────────────────────────────────────────────────────
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: euprava25-frontend
    ports:
      - "3000:80"
    depends_on:
      - api-gateway
    networks:
      - euprava-network
    restart: unless-stopped

networks:
  euprava-network:
    driver: bridge

volumes:
  sso_pgdata:
  school_pgdata:
  health_pgdata:
  uploads_data:
